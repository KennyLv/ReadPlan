define("discovery/helpers",["underscore","jquery","remote/config","core/switches"],function(a,b,c,d){"use strict";var e=function(b,e,f){var g=c.discovery||{},h=d.isFeatureActive("discovery_override")&&e.get("discoveryOverride"),i=h||b.discoveryVariant,j=g.variantSpecific||{};if(i)i=a.extend(a.omit(g,"variantSpecific"),{name:i,thumbnailsEnabled:b.discoveryThumbnailsEnabled},j[i]);else{if(!b.sponsoredCommentsEnabled)return;i={organicEnabled:!1,promotedEnabled:!1}}return f.disable_promoted&&!b.discoveryLocked&&(i.promotedEnabled=!1,i.thumbnailsEnabled=!1),i},f=!1,g=!1,h=function(a){f=!!a.lineTruncationEnabled,g=!!a.consoleLoggingEnabled},i=function(a){return b(a).closest("body").length&&!a.offsetTop},j=function(){};window.console&&(j=function(){if(g){var b=a.toArray(arguments);b.unshift("[Discovery]"),window.console.log.apply?window.console.log.apply(window.console,b):window.console.log(b.join(" "))}});var k=function(b){return a.isUndefined(b)?g:void(g=!!b)},l=function(b){return a.isUndefined(b)?f:void(f=!!b)},m=function(c,d){function e(){return k.scrollHeight-k.offsetHeight>.2*l}function g(){i.lastChild&&!a.contains(["...","…"],i.lastChild.nodeValue)&&(m=i.appendChild(window.document.createTextNode(" "+o)),e()&&(i.removeChild(m),i.removeChild(i.lastChild),g()))}if(f){if(!c.closest("body").length)return void j("lineTruncate called on el not on DOM");if(c.text().length<1)return void j("lineTruncated called on empty el");var h=function(a){return 3!==a.nodeType};if(a.any(c.children(),h))return void j("lineTruncate called on non-flat el");var i=c[0],k=i;if("block"!==c.css("display"))for(;k.parentNode&&(k=k.parentNode,"block"!==b(k).css("display")););var l=parseFloat(c.css("font-size"),10);if(e()){d=d||{};var m,n=d.lines||1,o=d.ellipsis,p=c.text();if(p.length){var q=c.width()/l,r=parseInt(q*n,10),s=p.split(/\s/),t=0;c.empty();for(var u=0,v=s.length;v>u&&(t+=s[u].length+1,!(t>=r));u++)i.appendChild(document.createTextNode(" "+s[u]));if(e()){do m=i.removeChild(i.lastChild);while(e())}else{do m=i.appendChild(document.createTextNode(" "+s[u++]));while(!e()&&v>u);i.removeChild(m)}o&&(a.isString(o)||(o="…"),g())}}}},n=function(b){function c(a,b){return a+b}var d,e,f=a.keys(b),g=Math.floor(a.reduce(b,c,0)/2),h=f.length+1,i=g+1,j=new Array(h);for(d=0;h>d;d++)j[d]=new Array(i),j[d][0]={};for(e=1;i>e;e++)j[0][e]=!1;var k,l,m,n={};for(e=1;i>e;e++)for(d=1;h>d;d++)k=f[d-1],l=b[k],m=a.clone(j[d-1][e]),!m&&e>=l&&(m=a.clone(j[d-1][e-l]),m&&(m[k]=l,n=m)),j[d][e]=m;return[n,a.omit(b,a.keys(n))]},o=["product","zone","service","experiment","variant"],p=function(b){b=b||"";var c=a.object(o,b.split(":"));return{bin:b,experiment:c.experiment||"",variant:c.variant||""}};return{generateVariantConfig:e,config:h,looksAdblocked:i,log:j,allowLog:k,allowLineTruncate:l,lineTruncate:m,balancedPartition:n,binToEventParams:p}}),define("discovery/models",["underscore","backbone","moment","core/analytics/identity","common/models","core/time","shared/corefuncs"],function(a,b,c,d,e,f,g){"use strict";var h=function(b){var c=b.prototype;return b.extend({defaults:{redirectUrl:null,signedUrl:null,userId:null,sourceThreadId:null,forumId:null,forum:null,majorVersion:null,requestBin:null},redirectPayload:function(){var b={url:this.get("signedUrl"),imp:d.impression.impId,prev_imp:d.impression.prevImp,forum_id:this.get("forumId"),forum:this.get("forum"),thread_id:this.get("sourceThreadId"),major_version:this.get("majorVersion")};return a.extend(b,this.get("service")),this.has("requestBin")&&(b.bin=this.get("requestBin")),this.has("userId")&&(b.user_id=this.get("userId")),b},redirectUrl:function(){var a=this.get("redirectUrl"),b=this.redirectPayload();return g.serialize(a,b)},toJSON:function(){var a=c.toJSON.call(this);return a.redirectUrl=this.redirectUrl(),a},toString:function(){return this.get("title")+" "+this.get("link")+" (id = "+this.id+")"}})}(b.Model),i=function(b){var d=b.prototype;return b.extend({defaults:a.defaults({createdAgo:!1},d.defaults),initialize:function(a,b){if(b&&b.humanFriendlyTimestamp){var d=f.assureTzOffset(this.get("createdAt"));d=c(d,f.ISO_8601),this.set("createdAgo",d.fromNow())}},redirectPayload:function(){var b=d.redirectPayload.call(this);return a.extend(b,{thread:this.id,zone:"thread",area:"discovery"}),b},toJSON:function(){var a=d.toJSON.call(this);return a.thumbnailUrl=a.thumbnail,a.preview&&(a.preview=a.preview.toJSON()),a},toString:function(){return"organic link: "+d.toString.call(this)}})}(h),j=function(b){var c=b.prototype;return b.extend({idAttribute:"advertisement_id",defaults:a.defaults({brand:null,headline:null,text:null,url:null,signedUrl:null,advertisement_id:null,tracking_pixels_onview:null},c.defaults),parse:function(a){return a.signedUrl=a.signed_url,a.thumbnailUrl=a.thumbnail_url,delete a.signed_url,a},get:function(a){return{title:this.attributes.headline,link:this.attributes.url}[a]||c.get.call(this,a)},redirectPayload:function(){var b=c.redirectPayload.call(this);return a.extend(b,{zone:"thread",area:"discovery",advertisement_id:this.get("advertisement_id"),brand:this.get("brand"),headline:this.get("headline")}),b},toJSON:function(){var a=c.toJSON.call(this);return a.title=a.headline,a.link=a.url,a},toString:function(){return"promoted link: "+c.toString.call(this)}})}(h),k=function(a){return a.extend({idAttribute:"advertisement_id",defaults:{ad_provider:null,advertisement_id:null,layout:"media_expansion",thumbnail_url:null,url:null,media_url:null,placement_id:null},set:function(b,c,d){return"None"===b.placement_id&&(b.placement_id=null),b.post&&(b.post.isSponsored=!0,b.post.hideViewAllComments=b.ad_provider,this.post=new e.Post(b.post),delete b.post),b.thread&&(this.thread=new e.Thread(b.thread),this.thread.forum=new e.Forum({settings:{allowMedia:!0}}),delete b.thread),a.prototype.set.call(this,b,c,d)}})}(b.Model),l={RelatedThread:i,Advertisement:j,SponsoredComment:k};return DISQUS.testing&&(l.BaseContentModel=h),l}),define("discovery/collections",["backbone","underscore","core/api","common/defines","core/utils/html","discovery/helpers","discovery/models"],function(a,b,c,d,e,f,g){"use strict";var h=a.Collection.extend({url:function(a){return c.getURL(a)},parse:function(a){return a.response}}),i=function(a){var b=a.prototype;return a.extend({url:function(){return b.url.call(this,"discovery/listTopPost.json")},parse:function(a){for(var c=b.parse.call(this,a),d=0,f=c.length;f>d;d++)c[d].plaintext=e.stripTags(c[d].message);return c}})}(h),j=function(a){return a.extend({initialize:function(){this.model=g[this.modelName]}})}(h),k=function(a){var b=a.prototype;return a.extend({modelName:"RelatedThread",url:function(){return b.url.call(this,"discovery/listRelated.json")}})}(j),l=function(a){var b=a.prototype;return a.extend({modelName:"Advertisement",url:"//tempest.services.disqus.com/listPromoted",initialize:function(a){return this.sponsoredComment=new g.SponsoredComment,b.initialize.call(this,a)},parse:function(a){return a.sponsored_comment&&a.sponsored_comment.length&&(a.sponsored_comment[0].placement_id=a.placement_id,this.sponsoredComment.clear(),this.sponsoredComment.set(a.sponsored_comment[0])),a.response||a.promoted_discovery}})}(j),m={PostCollection:i,RelatedThreadCollection:k,AdvertisementCollection:l};return DISQUS.testing&&(m.BaseCollection=h,m.BaseContentCollection=j),m}),define("discovery/custom-comments",["jquery","underscore","core/models/Media","shared/urls","shared/corefuncs","common/utils","common/urls","common/templates","exports"],function(a,b,c,d,e,f,g,h,i){"use strict";i.getProtocol=function(a){var b=(a||"").match(/^\s*(\w+:)?\/\//);return b?(b[1]||"").toLowerCase():null},i.getPageProtocol=function(){return window.location.protocol},i.forceWebProtocol=function(a,b){var c=i.getProtocol(a);if(null===c)return"";var e=i.getPageProtocol();return c||(c=e),"http:"===e&&(b=!0),"http:"===c&&b||(c="https:"),d.ensureHttpBasedProtocol(a,c)};var j=/<(\S+)[^<]+$/;i.extractTrackingTags=function(a){if(b.isArray(a))return b.map(a,function(a){return{tag:"img",url:a}});for(var c=f.bleachFindUrls(a),d=[],e=0;e<c.length;++e){var g=c[e],h=g.index,k=0;e>0&&(k=c[e-1].endIndex);var l=a.substr(k,h-k),m=j.exec(l);if(m){var n=m[1].toLowerCase();if("img"===n||"iframe"===n){var o=i.forceWebProtocol(g.url);o&&d.push({tag:n,url:o})}}}return d},i.handlers={};var k=function(a,d){if("OK"===d.status&&d.ad){var e=d.ad,f=a.post.toJSON();if(f.author){f.author.isRegistered=!1,f.author.hasSponsoredAvatar=!0,f.author.id=void 0,f.raw_message=b.escape(e.summary);var h=b.template('<p><a href="<%=url%>" target="_blank"><%=title%></a></p><%=summary%>');f.message=h({url:i.forceWebProtocol(e.url,!0),title:b.escape(e.title),summary:b.escape(e.summary)}),f.author.name=e.promotedBy,f.author.avatar=f.author.avatar||{},f.author.avatar.cache=f.author.avatar.permalink=i.forceWebProtocol(e.brandImageUrl)||g.avatar.generic;var j;if("story"===e.type)j="image_target",f.media=[];else{if("video"!==e.type)return;j="video",f.media=[{url:i.forceWebProtocol(e.embedUrl),mediaType:c.MEDIA_TYPES_UNKNOWN,htmlWidth:1280,htmlHeight:720}]}var k=i.extractTrackingTags(e.trackingTags),l=i.extractTrackingTags(e.viewableTags);this.ads.sponsoredComment.set({placement_id:a.get("placement_id"),ad_provider:a.get("ad_provider"),advertisement_id:a.id,thumbnail_url:i.forceWebProtocol(e.imageSrc),url:i.forceWebProtocol(e.url,!0),layout:j,post:f,thread:a.thread.toJSON(),tracking_pixels_onload:k,tracking_pixels_onview:l,title:b.escape(e.title)})}}};i.handlers.adsnative=function(c){return a.ajax({dataType:"jsonp",url:"https://api.adsnative.com/v1/ad.json",data:{url:this.get("sourceThreadUrl")}}).then(b.bind(k,this,c))},i.handlers.adsnativeVideoAds=function(c){return a.ajax({dataType:"jsonp",url:"https://api.adsnative.com/v1/ad.json",data:{url:this.get("sourceThreadUrl"),zid:"PySlQoeeO71JbyG53QDzMCzp2uRP_ip0yZmgoltF"}}).then(b.bind(function(a){a&&a.ad&&(a.ad.type="video"),k.call(this,c,a);var d=this.ads.sponsoredComment;d&&d.post.set(b.pick(a.ad,"title","summary"))},this))};var l=function(a,b){var d=null;if(b){var e=b["native"];if(e&&e.length&&(d=e),b.ads&&b.ads.length&&(d=b.ads),"ok"===b.status&&d){var f=d[0],j=a.post.toJSON();if(j.author){j.author.isRegistered=!1,j.author.hasSponsoredAvatar=!0,j.author.id=void 0;var k=f.main_media&&f.main_media[0],l=k&&k.url,m=f.custom||{};if(l&&f.description){var n={};try{n=JSON.parse(m.object)}catch(o){}var p=n.is_video,q=i.forceWebProtocol(decodeURIComponent(f.click_url),!0);p&&(j.media=[{url:i.forceWebProtocol(l),mediaType:c.MEDIA_TYPES_UNKNOWN,htmlWidth:k.width||1280,htmlHeight:k.height||720}]),j.raw_message=j.message=h.render("appNexusMessage",{url:q,title:f.title,summary:f.description}),j.author.name=m.brand_name||f.title,j.author.avatar=j.author.avatar||{},j.author.avatar.cache=j.author.avatar.permalink=f.icon_img_url||g.avatar.generic;var r=i.extractTrackingTags(f.impression_trackers);this.ads.sponsoredComment.set({placement_id:a.get("placement_id"),ad_provider:a.get("ad_provider"),advertisement_id:a.id,thumbnail_url:l,url:q,layout:p?"video":"image_target",post:j,thread:a.thread.toJSON(),tracking_pixels_onload:r})}}}}};i.handlers.appnexus=function(c){if(c.get("placement_id")){var d=a.Deferred(),g=f.CORS.request("GET",e.serialize("https://mobile.adnxs.com/mob",{id:c.get("placement_id"),size:"1x1",st:"web",version:1,referrer:this.get("sourceThreadUrl")}),function(){var a;try{a=JSON.parse(g.response)}catch(b){}d.resolve(a)},function(){d.reject()});d.done(b.bind(l,this,c)),g||d.reject();try{g.send()}catch(h){d.reject()}return d.promise()}},i.handlers.appnext=function(c){var d,e=this;return navigator.userAgent.match(/Android/i)&&(d="a8cb8499-482b-44b0-b928-6151311b7972"),navigator.userAgent.match(/iPhone|iPad|iPod/i)&&(d="37eaa010-7829-446f-b1c8-62cb57eec249"),d?a.ajax({dataType:"jsonp",url:"https://admin.appnext.com/offerWallApi.aspx",data:{id:d,type:"json",pimg:1,cnt:1}}).then(function(a,d){if("success"===d&&a.apps&&a.apps.length){var f=a.apps[0],g=c.post.toJSON();f&&g.author&&(g.raw_message=g.message=b.escape(f.desc),g.author.name=f.title,g.author.avatar=g.author.avatar||{},g.author.avatar.cache=g.author.avatar.permalink=i.forceWebProtocol(f.urlImg),g.author.isRegistered=!1,delete g.author.id,g.author.hasSponsoredAvatar=!0,g.media=[],e.ads.sponsoredComment.set({placement_id:c.get("placement_id"),ad_provider:c.get("ad_provider"),advertisement_id:c.id,thumbnail_url:i.forceWebProtocol(f.urlImg),url:i.forceWebProtocol(f.urlApp),layout:"image_target",post:g,thread:c.thread.toJSON()}))}}):void 0}}),define("discovery/variants",[],function(){"use strict";return{"default":{maxPerColumn:2,inlineMeta:!1,contentPreviews:!0,promotedEnabled:!1,topPlacementEnabled:!1},promoted:{maxPerColumn:4,inlineMeta:!0,contentPreviews:!1,promotedEnabled:!0,topPlacementEnabled:!1,promotedSide:"right"},max:{maxPerColumn:4,inlineMeta:!0,contentPreviews:!1,promotedEnabled:!0,topPlacementEnabled:!0,promotedSide:"left"},thumbnails:{maxOrganicThumbnailLinks:0,maxPromotedThumbnailLinks:4,promotedSide:"left",numLinesHeadline:4}}}),define("discovery/views",["backbone","underscore","jquery","stance","core/analytics/jester","core/bus","core/strings","common/templates","common/utils","discovery/helpers"],function(a,b,c,d,e,f,g,h,i,j){"use strict";var k=g.get,l=a.View.extend({getTemplateContext:function(){return this.appContext||(this.appContext=this.model.toJSON()),{variant:this.appContext}},template:function(a,b){return b=b||this.templateName,h.render(b,a)},report:function(a){this.model.report(b.extend({object_type:"advertisement",area:"promoted_discovery"},a))}}),m=function(a){var e=a.prototype;return a.extend({events:{"click [data-redirect]":"handleClick"},templateName:"discoveryCollection",handleClick:function(a){this.swapHref(a.currentTarget)},swapHref:function(a){a.setAttribute("data-href",a.getAttribute("href")),a.setAttribute("href",a.getAttribute("data-redirect")),b.delay(function(){a.setAttribute("href",a.getAttribute("data-href"))},100)},initialize:function(a){e.initialize.call(this,a),this.elementsSelector="li.discovery-post",this.$elements=this.$el.find(this.elementsSelector),this.initContext=a.context;var b=this.collection;this.listenTo(b,{remove:this.remove,reset:this.render}),this.visibilityTrackers={},this.queueViewEvents()},queueViewEvents:function(){if(this.model.get("promotedEnabled")){var a=function(){return c(this.el).height()/2};b.each(this.visibilityTrackers,function(a,b){a&&(this.collection.get(b)||(this.stopListening(a),this.visibilityTrackers[b]=null))},this),b.each(this.$elements,function(c){var e=c.getAttribute("data-id");if(!this.visibilityTrackers[e]){var f=this.collection.get(e);if(f){var g=d({el:c,timer:null,topEdgeOffset:a,bottomEdgeOffset:a});this.visibilityTrackers[e]=g;var h=b.bind(function(){this.reportIABView(e),this.stopListening(g)},this);this.listenTo(g,{enter:function(){g.timer=b.delay(h,1e3)},exit:function(){clearTimeout(g.timer)}})}}},this)}},reportIABView:function(a){var c=this.collection.get(a),d=c.get("tracking_pixels_onview")||[];i.loadPixels(d,b.bind(this.pixelLoadErrorCallback,this,a),this.$el)},loadOnLoadPixels:function(){this.collection.each(function(a){var c=a.get("tracking_pixels_onload")||[],d=a.id;i.loadPixels(c,b.bind(this.pixelLoadErrorCallback,this,d),this.$el)},this)},pixelLoadErrorCallback:function(a,b){this.report({verb:"load",adverb:"failed",adjective:"tracking-pixel",object_type:"service",object_id:b,advertisement_id:a})},truncate:function(){var a=this.$el.find(".line-truncate");b.each(a,function(a){var b=c(a);j.lineTruncate(b,{lines:parseInt(b.attr("data-line-truncate"),10),ellipsis:!0})})},getTemplateContext:function(){var a=e.getTemplateContext.call(this);b.extend(a,this.initContext),a.collection=this.collection.toJSON();var c=this.collection.at(0);if(c){var d=c.has("id")?"organic-":"promoted-",f=c.idAttribute;b.each(a.collection,function(a){a.advertisement_id=a[f],a.domIdSuffix=a[f],a.domIdSuffix=d+a.domIdSuffix})}return a},render:function(){var a=this.getTemplateContext();return this.$el.html(this.template(a)),this.$elements=this.$el.find(this.elementsSelector),this.truncate(),this.loadOnLoadPixels(),this.queueViewEvents(),this},remove:function(a,d,e){if(0===arguments.length)return l.prototype.remove.call(this);var f=b.toArray(this.$elements),g=f.splice(e.index,1)[0];return c(g).remove(),this.$elements=c(f),this.queueViewEvents(),this}})}(l),n=function(a,b){this.modelIds=a||[],this.$elements=c(b||[])};b.extend(n.prototype,{height:function(){var a=this;a.heights=[];var d=c(a.$elements),e=d.first().offset().top,f=function(){var a=d.last();return a.offset().top+a.height()}(),g=f-e,h=0;return b.each(d,function(b){var d=c(b).height();a.heights.push(d),h+=d}),this.interstice=(g-h)/(d.length-1),g}});var o=function(){this.divideIntoColumns=function(){var a=this,b=a.subviews[0];a.left=new n,a.right=new n;var c=0;b.collection.each(function(d,e){var f=c++%2===0?"left":"right";a[f].modelIds.push(d.id),Array.prototype.push.call(a[f].$elements,b.$elements[e])})},this.removeOneFromColumn=function(a,c){var d,e=b.chain(a.modelIds).map(function(b,c){return[b,a.heights[c]]}).sortBy(function(a){return-1*a[1]}).find(function(a){return a[1]<=c}).value()[0],f=this.subviews[0].collection,g=f.models,h=f.get(e),i=g.indexOf(h),j=[],k=[],l=[k,j],m=g.length;for(d=0;m>d;d++)l[d%2].push(g[d]);var n=l[i%2];n.splice(b.indexOf(n,h),1),g=[];var o=(i+1)%2;for(d=0;m-1>d;d++)g.push(l[(d+o)%2].shift());f.reset(g)},this.balanceColumns=function(){var a=this.subviews[0],c=a.collection,d={};c.each(function(b,c){d[c]=a.$elements[c]});var e=j.balancedPartition(d);e=b.sortBy(e,"length");var f=e[1],g=e[0],h=c.models,i=new Array(h.length);b.each(f,function(a,b){i[2*b]=h[b]}),b.each(g,function(a,b){i[2*b+1]=h[b]}),c.reset(h)},this.shortenColumn=function(a,b){var c=this.subviews[0].collection;c.length%2!==0&&a===this.left?this.removeOneFromColumn(a,this.fudge*b):this.balanceColumns()}},p=function(){this.divideIntoColumns=function(){var a=this,b=a.subviews,c=b[0],d=b[1],e=c.collection.model.prototype.idAttribute;a.left=new n(c.collection.pluck(e),c.$elements);var f=d.collection.model.prototype.idAttribute;a.right=new n(d.collection.pluck(f),d.$elements)},this.shortenColumn=function(a,c){for(var d=a===this.left?this.subviews[0]:this.subviews[1],e=a===this.left?this.right:this.left,f=e,g=c/f.$elements.length,h=d.collection,i=b.chain(a.modelIds).map(function(b,c){return[b,a.heights[c]]}).sortBy(function(a){return a[1]}).value(),j=[],k=0,l=c,m=g;i.length;){var n=i.pop(),o=n[0],p=n[1],q=p+a.interstice;if(k+q>c&&(f=a),l=Math.abs(c-(k+q)),m=l/f.$elements.length,!(m>=g)){g=m;var r=a.modelIds.indexOf(o);a.modelIds.splice(r,1),Array.prototype.splice.call(a.$elements,r,1),k+=q,j.push(o)}}h.remove(j)}},q=function(a){this.fudge=a.fudge,this.subviews=a.views.slice(0,2),1===this.subviews.length?o.call(this):p.call(this)};b.extend(q.prototype,{ascendingByHeight:function(){var a=this.left,c=this.right,d=[[a,a.height()],[c,c.height()]];return b.sortBy(d,function(a){return a[1]})},evenColumns:function(a){var c=this.ascendingByHeight(),d=c[0][0],e=c[0][1],f=c[1][0],g=c[1][1];if(e!==g){var h=g-e,i=this.fudge*h,j=b.find(f.heights,function(a){return a+f.interstice<i});return!a&&j?(this.shortenColumn(f,h),this.divideIntoColumns(),this.evenColumns("do not recurse again")):void this.increaseMargins(d,h)}},increaseMargins:function(a,d){var e=a.$elements.length;if(!(2>e)){var f=d/e;b.each(a.$elements,function(a){var b=c(a),d=parseInt(b.css("margin-bottom"),10),e=d+f;b.css("margin-bottom",e+"px")});var g=a===this.left?this.right:this.left,h=a===this.right?"left":"right";g.$elements.css("clear",h)}},render:function(){return this.divideIntoColumns(),this.evenColumns(),this}});var r=function(a){var c=a.prototype;return a.extend({templateName:"discoveryMain",topEdgeOffset:0,bottomEdgeOffset:1/0,events:{"click [data-action=discovery-help]":function(a){a.preventDefault(),this.model.set("help",!0)},"click [data-action=discovery-help-close]":function(a){a.preventDefault(),this.model.set("help",!1)}},toggleHelp:function(a){var b=this;b.$el.find("#discovery-note").toggle(),a.trigger("resize")},rerenderHelp:function(){var a=this.$el.find("#discovery-note");a.length&&a.html(this.template(this.getTemplateContext(),"discoveryNote"))},initialize:function(a){c.initialize.call(this,a),this.listenTo(this.model,{"change:display":this.show,"change:help":this.toggleHelp}),this.listenTo(this.model.get("session"),"change",this.rerenderHelp),this.$el.css({position:"absolute",visibility:"hidden",display:"block",width:this.$el.width()-20+"px"})},createSections:function(){var a=this.model,c=a.get("sectionNames"),d=a.get("sectionIds");return b.map(a.collections,function(b,e){var f,g="";return b===a.threads?f="organic":b===a.ads&&(f="promoted",b.each(function(a){if(a)switch(a.get("brand")){case"Women & Co":g=k("Sponsored Stories");break;case"American Express OPEN":g=k("Sponsored Links")}})),{id:d[e],className:c[e],type:f,showThumbnailsInRows:"promoted"===f&&a.getThumbnailLinksMobile("Promoted"),promotedTitle:g}})},getTemplateContext:function(){var a=this.model,b=this.createSections(),c=a.get("maxOrganicThumbnailLinks")||a.get("maxPromotedThumbnailLinks");return{id:a.get("innerContainerId"),sections:b,styleVariant:a.get("styleVariant"),forum:a.get("sourceForum"),discoverySettingsUrl:a.get("promotedEnabled")&&a.get("discoverySettingsUrl"),session:a.get("session").toJSON(),thumbnailsEnabled:c}},render:function(){this.$el.html(this.template(this.getTemplateContext()))},show:function(a){a.get("display")&&(this.$el.css({position:"static",visibility:"visible",width:"100%"}),a.trigger("resize"))},remove:function(a){var b;return a&&a.cloneContainer&&(b=this.el.cloneNode(!1),this.$el.attr("id",""),this.$el.after(b)),c.remove.call(this)}})}(l);return{BaseCollectionView:m,TwoColumn:q,MainView:r}}),define("discovery/views/mixins",["jquery","modernizr","underscore","stance"],function(a,b,c,d){"use strict";function e(b){var e,f=function(){return a(b.el).height()/2},g=d({el:b.el,topEdgeOffset:f,bottomEdgeOffset:f}),h=function(){b.trigger("view:iab",b),b.stopListening(g)};b.listenTo(g,{enter:function(){e=c.delay(h,1e3)},exit:function(){window.clearTimeout(e)}})}var f={setupViewabilityTracking:function(){e(this),this.listenTo(this,"view:iab",function(){this.report({verb:"view",adverb:"iab-scroll"}),c.isFunction(this.loadOnViewPixel)&&this.loadOnViewPixel()})}};return{setupViewEvents:e,TrackAdViewabilityMixin:f}}),define("discovery/views/countdown-timer",["backbone","underscore","common/templates"],function(a,b,c){"use strict";return a.View.extend({template:"countdownTimer",className:"countdown-timer",initialize:function(c){this.duration=c.duration||5e3,this.model=new a.Model({active:!1,text:0,remaining:0}),this.listenTo(this.model,"change",this.updateUI),b.bindAll(this,"tickAnimation")},updateUI:function(){this.$el[this.model.get("active")?"addClass":"removeClass"]("active"),this.$text&&this.$text.text(this.model.get("text")),this.$path&&this.pathLength&&this.$path.css("stroke-dashoffset",this.model.get("remaining")*this.pathLength)},render:function(){return this.$el.html(c.render(this.template)),this.$path=this.$el.find("[data-role=countdown-path]"),this.$text=this.$el.find("[data-role=countdown-text]"),this.updateUI(),this.pathLength=this.$path.length&&this.$path[0].getTotalLength&&this.$path[0].getTotalLength(),this.$path.css("stroke-dasharray",this.pathLength),this},startAnimation:function(){this.model.get("active")||(this.model.set("active",!0),this.updateUI(),this.startTime=null,this.timer=window.requestAnimationFrame(this.tickAnimation))},tickAnimation:function(a){null===this.startTime&&(this.startTime=a);var b=(a-this.startTime)/this.duration;if(b>=1)this.model.set("active",!1),this.trigger("animation-complete");else{var c=1-Math.max(0,Math.min(b,1));this.model.set({text:Math.ceil(c*this.duration/1e3),remaining:c}),this.timer=window.requestAnimationFrame(this.tickAnimation)}},cancelAnimation:function(){this.model.set("active",!1),window.cancelAnimationFrame(this.timer)}})}),define("discovery/views/BaseUnit",["backbone","underscore","jquery","stance"],function(a,b,c,d){"use strict";return a.View.extend({setupViewEvents:function(){var a,e=this,f=function(){return c(this.el).height()/2},g=d({el:this.el,topEdgeOffset:f,bottomEdgeOffset:f}),h=function(){e.trigger("view:iab",e),e.stopListening(g)};this.listenTo(g,{enter:function(){a=b.delay(h,1e3)},exit:function(){window.clearTimeout(a)}})},reportIABView:function(){this.report({verb:"view",adverb:"iab-scroll"})},reportLoad:function(){this.report({verb:"load"})},reportPixelErrors:function(a){this.report({verb:"load",adverb:"failed",adjective:"tracking-pixel",object_type:"service",object_id:a})}})}),define("discovery/views/BasicDirectResponseUnit",["underscore","discovery/views/BaseUnit","common/utils","core/analytics/jester","discovery/helpers"],function(a,b,c,d,e){"use strict";var f=b.extend({initialize:function(b){this.render=a.compose(this.render,a.bind(this.trigger,this,"render")),this.setupViewEvents(),this.listenTo(this,"view:iab",this.reportIABView),this.listenTo(this,"render",this.reportLoad),this.listenTo(this,"view:iab",this.fireViewPixels),this.listenTo(this,"render",this.fireLoadPixels),this.session=b.session,this.sponsoredComment=b.sponsoredComment,this.sourceForum=b.sourceForum,this.sourceThread=b.sourceThread,this.requestBin=b.requestBin,this.styleVariant=b.styleVariant},fireViewPixels:function(){var b=this.sponsoredComment.get("tracking_pixels_onview")||[],d=this.sponsoredComment.get("tracking_pixel_url");d&&b.push({tag:"img",url:d}),c.loadPixels(b,a.bind(this.reportPixelErrors,this),this.$el)},fireLoadPixels:function(){var b=this.sponsoredComment.get("tracking_pixels_onload")||[];c.loadPixels(b,a.bind(this.reportPixelErrors,this),this.$el)},report:function(b){var c=[this.sponsoredComment.id],f=e.binToEventParams(this.requestBin);d.client.emit(a.defaults(b,{object_type:"advertisement",object_id:JSON.stringify(c),zone:"thread",area:"sponsored_comment",post_id:this.sponsoredComment.post.id,advertisement_id:this.sponsoredComment.id,thread_id:this.sourceThread.id,forum_id:this.sourceForum.pk,user_id:this.session.user&&this.session.user.id},f))}});return f}),define("discovery/views/IframeUnit",["jquery","underscore","backbone","core/bus","core/analytics/jester","core/strings","common/templates","discovery/views/BaseUnit"],function(a,b,c,d,e,f,g,h){"use strict";var i=f.get,j="ready",k="fail",l={ready:j,fail:k,"viroolWidget.playerReady":j,"viroolWidget.noOffers":k},m=h.extend({initialize:function(a){this.model=a.sponsoredComment,this.setupViewEvents(),this.listenTo(this,"view:iab",this.reportIABView),this.listenTo(d.frame,"embed.resized",b.debounce(b.bind(this.render,this),100)),this.handleIframePostMessages=b.bind(this.handleIframePostMessages,this)},isEmbedHidden:function(){return!a("body").width()},getIframeUrl:function(){return this.model.get("media_url")},serializeData:function(){var c,d=this.getIframeUrl(),e=this.model.get("width")||640,f=this.model.get("title")||i("Sponsored Video");return e=Math.min(e,a("body").width()),c=e/1.6,{title:f,iframeUrl:b.template(d)({width:e,height:c}),height:c,width:e}},report:function(a){return e.client.emit(b.defaults(a,{object_type:"advertisement",object_id:JSON.stringify([this.model.id]),zone:"thread",area:"sponsored_comment",advertisement_id:this.model.id,ad_product:"sponsored_video",adjective:"video_iframe",thread_id:e.client.get("thread")}))},handleIframePostMessages:function(b){var c=this.serializeData();if(0===c.iframeUrl.indexOf(b.originalEvent.origin)){var d=b.originalEvent.data;switch(l[d]){case j:this.$el.show(),a(window).off("message",this.handleIframePostMessages),this.report({verb:"load"});break;case k:a(window).off("message",this.handleIframePostMessages),this.remove()}}},render:function(){return this.isEmbedHidden()?this:(this.stopListening(d.frame,"embed.resized"),a(window).on("message",this.handleIframePostMessages),this.$el.hide().html(g.render("iframeAd",this.serializeData())),this.$iframeEl=this.$el.find("[data-role=iframe-ad]"),this)}});return m}),define("discovery/views/sponsored-comment",["backbone","jquery","underscore","stance","remote/config","core/bus","core/config","core/analytics/jester","common/models","common/templates","common/utils","discovery/views/mixins","core/utils","core/strings","discovery/helpers","discovery/views/countdown-timer","discovery/views/BasicDirectResponseUnit","discovery/views/IframeUnit","lounge/views/post","lounge/views/posts","lounge/views/media"],function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u){"use strict";var v=s.extend({inViewport:!1,layout:void 0,moatScriptUrl:"//js.moatads.com/<%=moatId%>/moatad.js#moatClientLevel1=Disqus&moatClientLevel2=<%=adId%>&moatClientLevel3=<%=adId%>&moatClientLevel4=<%=isLoggedIn%>&moatClientSlicer1=<%=forumId%>&moatClientSlicer2=<%=threadId%>",events:c.extend({},s.prototype.events,{"mouseenter.reportHover":"scheduleHoverReport","mouseleave.reportHover":"cancelHoverReport","click [data-action=feedback]":"showSurvey","mouseenter [data-role=iframe-player]":"schedulePredictedClickReport","mouseleave [data-role=iframe-player]":"cancelPredictedClickReport","click [data-role=thread-link]":"reportOpenedSponsoredThread","click > [data-role=post-content] [data-action]":"reportDataAction","click [data-role=sponsored-text] a":"reportLinkClick"}),getReportOptionsByAction:function(a){var b;switch(a){case"click_image":b={verb:"click",adjective:"image"};break;case"downvote":b={verb:"dislike"};break;case"upvote":b={verb:"like"};break;case"feedback":b={verb:"click",object_type:"link",object_id:e.lounge.sponsored_comment_survey_url,adjective:"feedback"};break;case"reply":b={verb:"post",object_type:"post",object_id:this.model.id};break;case"profile":b={verb:"click",object_type:"zone",object_id:"profile",adjective:"profile"}}return b},reportDataAction:function(a){var c=s.prototype.events["click > [data-role=post-content] [data-action]"].apply(this,arguments),d=b(a.currentTarget).attr("data-action"),e=this.getReportOptionsByAction(d);return e&&this.report(e),c},scheduleHoverReport:function(){this.isMouseInsideComment=!0,this.debouncedReportHoverOnce()},reportHover:function(){this.isMouseInsideComment&&(this.report({verb:"hover",adverb:"3000ms"}),this.$el.off(".reportHover"))},cancelHoverReport:function(){this.isMouseInsideComment=!1},schedulePredictedClickReport:function(){this.isMouseInsidePlayer=!0,this.debouncedReportPredictedClick()},reportPredictedClick:function(){this.isMouseInsidePlayer&&(this.report({verb:"hover",adverb:"3000ms",adjective:"iframe"}),this.$el.off("mouseenter mouseleave","[data-role=iframe-player]"))},cancelPredictedClickReport:function(){this.isMouseInsidePlayer=!1},reportLinkClick:function(a){a.stopPropagation(),this.report({verb:"click",object_type:"link",object_id:b(a.currentTarget).attr("href"),adjective:"content"})},initialize:function(a){this.debouncedReportPredictedClick=c.debounce(c.bind(this.reportPredictedClick,this),3e3),this.debouncedReportHoverOnce=c.debounce(c.bind(c.once(this.reportHover),this),3e3),this.sponsoredComment=a.sponsoredComment,this.session=a.session,this.userSuggestions=a.userSuggestions,this.styleVariant=a.styleVariant,this.sponsoredCommentExperiment=a.sponsoredCommentExperiment,this.sourceForum=a.sourceForum,this.sourceThread=a.sourceThread,this.requestBin=a.requestBin,this.injectScriptUrl=a.injectScriptUrl,this.layout=a.layout||this.layout,this.topEdgeOffset=this.getHalfHeight,this.bottomEdgeOffset=this.getHalfHeight,this.viewEventState={hasReportedFastView:!1,hasReportedIABView:!1,timers:[],iabNoScrollingTimer:null},this.viewEventConfig={viewDurations:[],viewDurationReportFns:[]},this.shouldTrackAdditionalEvents()&&(this.viewEventConfig.viewDurations=[0,200,400,800],this.viewEventConfig.viewDurationReportFns=c.map(this.viewEventConfig.viewDurations,function(a){return c.once(c.bind(this.report,this,{verb:"view",adverb:a+"ms"}))},this)),this.listenTo(f.frame,"window.scroll",this.queueViewEvents),s.prototype.initialize.apply(this,arguments)
},shouldTrackAdditionalEvents:function(){return k.shouldSample((e.lounge||{}).sc_analytics_sample_percent)},getHalfHeight:function(){return this.$el.height()/2},queueViewEvents:function(){var a=this.viewEventState;if(!a.hasReportedFastView){if(!this.isPartiallyVisible())return;this.report({verb:"view",adverb:"0ms-no50perc"}),a.hasReportedFastView=!0}var b=d(this).isVisible();if(b!==this.inViewport)if(b){a.hasReportedIABView||a.timers.push(c.delay(c.bind(this.reportIABView,this),1e3));var e=this.viewEventConfig;c.each(e.viewDurations,function(b,d){var f=e.viewDurationReportFns[d];a.timers.push(c.delay(f,b))})}else clearTimeout(a.iabNoScrollingTimer),c.map(a.timers,clearTimeout),a.timers=[];this.inViewport=b,b&&(clearTimeout(a.iabNoScrollingTimer),a.iabNoScrollingTimer=c.delay(c.bind(function(){this.report({verb:"view",adverb:"iab-no-scrolling"}),this.stopListening(f.frame,"window.scroll",this.queueViewEvents)},this),1e3))},isPartiallyVisible:function(){return this.partialVisibilityWrapper||(this.partialVisibilityWrapper=d({el:this.el})),this.partialVisibilityWrapper.isVisible()},reportIABView:function(){this.viewEventState.hasReportedIABView=!0,this.report({verb:"view",adverb:"iab-scroll"}),this.loadOnViewPixel()},loadOnViewPixel:function(){var a=this.sponsoredComment.get("tracking_pixels_onview")||[],b=this.sponsoredComment.get("tracking_pixel_url");b&&a.push({tag:"img",url:b}),k.loadPixels(a,c.bind(this.pixelLoadErrorCallback,this),this.$el)},loadOnLoadPixels:function(){var a=this.sponsoredComment.get("tracking_pixels_onload")||[];k.loadPixels(a,c.bind(this.pixelLoadErrorCallback,this),this.$el)},pixelLoadErrorCallback:function(a){this.report({verb:"load",adverb:"failed",adjective:"tracking-pixel",object_type:"service",object_id:a})},report:function(a){var b=[this.sponsoredComment.id],d=o.binToEventParams(this.requestBin);h.client.emit(c.defaults(a,{object_type:"advertisement",object_id:JSON.stringify(b),zone:"thread",area:"sponsored_comment",post_id:this.model.id,advertisement_id:this.sponsoredComment.id,thread_id:this.sourceThread.id,forum_id:this.sourceForum.pk,user_id:this.session.user&&this.session.user.id,ad_product_name:"dr"},d))},getPostAttributes:function(){var a=s.prototype.getPostAttributes.apply(this,arguments);return a.message=j.render("sponsoredComment",{message:a.message,layout:this.layout,thumbnailUrl:this.sponsoredComment.get("thumbnail_url"),targetUrl:this.sponsoredComment.get("url"),isMobile:m.isMobileUserAgent(),showCallToAction:this.isCallToActionEnabled()}),a},render:function(){s.prototype.render.apply(this,arguments),this.$el.addClass("sponsored"),this.$el.addClass("style-variant-"+this.styleVariant),this.report({verb:"load"}),this.loadOnLoadPixels();var a=this.session.get("thread");return this.injectScriptUrl&&!this.session.isLoggedIn()&&b("<script>").attr("src",c.template(this.injectScriptUrl)({adId:this.sponsoredComment.id,threadId:a.id,forumId:a.get("forum")})).appendTo(this.$el),this.sponsoredComment.get("moat_id")&&b("<script>").attr("src",c.template(this.moatScriptUrl)({adId:this.sponsoredComment.id,threadId:a.id,forumId:a.forum&&a.forum.get("pk"),moatId:this.sponsoredComment.get("moat_id"),isLoggedIn:this.session.isLoggedIn()?1:0})).appendTo(this.$el),this},isCallToActionEnabled:function(){return"call_to_action"===this.sponsoredCommentExperiment&&!m.isMobileUserAgent()},showSurvey:function(){var a=m.isMobileUserAgent()?{}:{width:500,height:550,scrollbars:"yes",resizable:"yes",status:"yes"};k.windowOpen(e.lounge.sponsored_comment_survey_url,"surveywindow",a)},getReplyView:function(){return this.reply?this.reply:(this.reply=new t.PostReplyView({parentView:this,parent:this.model,thread:this.thread,session:this.options.session,userSuggestions:this.userSuggestions}),this.reply.render(),this.showReply(),this.thread.once("create",c.bind(this.renderReply,this)),this.reply)},renderReply:function(a){var b=new s({parent:this,model:a,thread:this.thread,session:this.session,created:a.created});b.render();var c=this;c.$("[data-role=children]").append(b.$el)},reportOpenedSponsoredThread:function(a){var c=b(a.currentTarget).find("a");c&&c.length&&this.report({verb:"click",object_type:"link",object_id:c.attr("href"),adjective:"all-comments"})},initProfileCard:function(){}}),w=v.extend({layout:"expandableMedia",events:c.extend({},v.prototype.events,{"click [data-action=click_media_expand]":"expandMedia"}),initialize:function(){this.isAutoExpandExperimentEnabled()&&this.listenTo(d(this),{enter:this.startCountdown,exit:this.stopCountdown}),v.prototype.initialize.apply(this,arguments)},getReportOptionsByAction:function(a){var b=v.prototype.getReportOptionsByAction.apply(this,arguments);return"click_media_expand"===a&&(b={verb:"click",adjective:"media"}),b},expandMedia:k.preventDefaultHandler(function(){var a=this.$("[data-role=media-trigger]");this.$("[data-role=learn-more]").remove(),this.teardownCountdown();var b=c.first(this.richMediaViews);b&&(a.hide(),b.activate(),this.isAutoExpandExperimentEnabled()&&b.send("play"))}),render:function(){return v.prototype.render.apply(this,arguments),this.setupCountdown(),this},renderMedia:function(){var a=this.model.media,b=this.sponsoredComment.get("media_url");a&&a.length||!b||a.reset([{url:b,mediaType:i.Media.MEDIA_TYPES.UNKNOWN}]),s.prototype.renderMedia.apply(this,arguments)},renderRichMedia:function(a,c){var d=this.model.cid,e=a.first(),f=u.getRichMediaViewConfig(e,d);f.mediaViewModel.set({showButtons:!1,deferred:this.isAutoExpandExperimentEnabled(),playerjs:this.isAutoExpandExperimentEnabled(),respectSettings:!1});var g=new f.Cls({model:f.mediaViewModel,media:e,template:j.getTemplate("sponsoredCommentMedia")});return g.relatedPost=d,g.render(),b("<li>").append(g.$el).appendTo(c),this.richMediaViews=[g],this.richMediaViews},isAutoExpandExperimentEnabled:function(){return"auto_expand"===this.sponsoredCommentExperiment},startCountdown:function(a){a&&a.stopPropagation(),this.$el.addClass("countdown-active"),this.countdown.startAnimation()},stopCountdown:function(a){a&&a.stopPropagation(),this.$el.removeClass("countdown-active"),this.countdown.cancelAnimation()},setupCountdown:function(){if(this.teardownCountdown(),this.countdown=new p({duration:this.isAutoExpandExperimentEnabled()?5e3:3e3}).render(),this.isAutoExpandExperimentEnabled()){var a=c.first(this.richMediaViews);a&&a.$el.append(this.countdown.$el).css("position","relative"),this.countdown.$el.attr("data-action","click_media_expand"),this.$("[data-role=media-trigger]").hide()}else{var b=this.$el.find("[data-role=media-expand]");b||this.teardownCountdown(),b.prepend(this.countdown.$el)}if(this.listenTo(this.countdown,"animation-complete",this.onCountdownComplete),this.$el.off(".hoverToExpand"),!this.isAutoExpandExperimentEnabled()){var d=c.bind(this.startCountdown,this),e=c.bind(this.stopCountdown,this);this.$el.on("mouseenter.hoverToExpand",d),this.$el.on("mouseenter.hoverToExpand","[data-role=message]",d),this.$el.on("mouseleave.hoverToExpand",e),this.$el.on("mouseenter.hoverToExpand","footer menu, [data-role=user-avatar]",e)}},teardownCountdown:function(){this.countdown&&(this.stopListening(this.countdown),this.countdown.remove())},onCountdownComplete:function(){if(this.isAutoExpandExperimentEnabled()){this.report({verb:"view",adverb:"5000ms"});var a=c.first(this.richMediaViews);a&&a.send("mute"),this.expandMedia()}else this.report({verb:"hover",adverb:"3000ms"}),this.expandMedia(),this.$el.off(".hoverToExpand")}}),x=v.extend({initialize:function(a){this.sponsoredComment=a.sponsoredComment,v.prototype.initialize.apply(this,arguments)},getPostAttributes:function(){var a=s.prototype.getPostAttributes.apply(this,arguments);return a.author.avatar.cache===g.urls.avatar.generic&&(a.author.avatar.cache=void 0),a.targetUrl=this.sponsoredComment.get("url"),a},render:function(){return this.report({verb:"load"}),this.loadOnLoadPixels(),this.$el.addClass("sponsored"),this.$el.html(j.render("videoAd",this.getPostAttributes())),this}});return{SponsoredPostView:v,SponsoredPostExpandableMediaView:w,SponsoredVideoView:x}}),define("discovery/views/VastUnit",["jquery","underscore","stance","backbone","remote/config","discovery/views/IframeUnit"],function(a,b,c,d,e,f){"use strict";var g=f.extend({events:{"mouseenter [data-role=iframe-wrapper]":"turnSoundOn","mouseleave [data-role=iframe-wrapper]":"turnSoundOff"},supportedSizes:[{width:320,height:180},{width:480,height:352},{width:640,height:360}],initialize:function(a){this.session=a.session,this.sourceForum=a.sourceForum,this.sourceThread=a.sourceThread,this.requestBin=a.requestBin,b.bindAll(this,"showPlayer","reportVideoComplete","reportPlay","reportError");var d=c({el:this.el,topEdgeOffset:this.halfHeight,bottomEdgeOffset:this.halfHeight});this.listenTo(d,{enter:this.startAd}),f.prototype.initialize.apply(this,arguments)},getIframeUrl:function(){return e.discovery.videoPlayerUrl||""},handleIframePostMessages:function(a){if(0===this.getIframeUrl().indexOf(a.originalEvent.origin)){var b=a.originalEvent.data;switch(b){case"iframeLoaded":this.initVideoPlayer();break;case"ready":this.showPlayer();break;case"play":this.reportPlay();break;case"error":this.reportError();break;case"ended":this.reportVideoComplete()}}},postIframeMessage:function(a){var b=this.$iframeEl.get(0);b.contentWindow.postMessage(JSON.stringify(a),"*")},initVideoPlayer:function(){var a=this.$el.parent().width(),c=b.find(this.supportedSizes,function(b){return b.width>a});c=c||b.last(this.supportedSizes),this.postIframeMessage({method:"initPlayer",url:this.model.get("media_url"),width:c.width,height:c.height})},showPlayer:function(){this.$el.show(),this.report({verb:"load"})},reportPlay:function(){this.hasStarted=!0,this.report({verb:"start-playing"})},reportError:function(){this.report({verb:"error",adjective:this.player.src()})},reportVideoComplete:function(){this.hasStarted&&this.report({verb:"finish-playing"})},halfHeight:function(){return a(this.el).height()/2},startAd:function(){this.postIframeMessage({method:"playVideo"})},turnSoundOn:function(){this.postIframeMessage({method:"turnSoundOn"})},turnSoundOff:function(){this.postIframeMessage({method:"turnSoundOff"})}});return g}),define("discovery/views/Placement",["underscore","backbone","common/templates","discovery/views/sponsored-comment","discovery/views/IframeUnit","discovery/views/VastUnit"],function(a,b,c,d,e,f){"use strict";var g=b.View.extend({template:"sponsoredCommentWrapper",itemViewContainer:".post-list",LAYOUT_TO_CLASS:{media_expansion:d.SponsoredPostExpandableMediaView,image_target:d.SponsoredImageView,video:d.SponsoredVideoView,video_vast:f,iframe:e},initialize:function(a){this.session=a.session,this.styleVariant=a.styleVariant,this.userSuggestions=a.userSuggestions,this.visible=a.visible,this.sourceForum=a.sourceForum,this.sourceThread=a.sourceThread,this.requestBin=a.requestBin,this.sponsoredCommentExperiment=a.sponsoredCommentExperiment,this.injectScriptUrl=a.injectScriptUrl,this.initSubViews(),this.listenTo(this.model,"change",function(){this.initSubViews(),this.render()})},getViewClassByLayout:function(a){return this.LAYOUT_TO_CLASS[a]||d.SponsoredPostExpandableMediaView},initSubViews:function(){if(this.removeSubViews(),this.model){var a=this.model.post,b=this.model.thread;if(a&&b){var c=this.getViewClassByLayout(this.model.get("layout")),d=new c({model:a,thread:b,sourceForum:this.sourceForum,sourceThread:this.sourceThread,styleVariant:this.styleVariant,sponsoredCommentExperiment:this.sponsoredCommentExperiment,sponsoredComment:this.model,session:this.session,userSuggestions:this.userSuggestions,requestBin:this.requestBin,injectScriptUrl:this.injectScriptUrl,excludeAnchor:!0}).stopListening(a.usersTyping);this.adView=d}}},removeSubViews:function(){this.adView&&this.adView.remove()},setVisible:function(a){a!==this.visible&&(this.visible=a,this.render())},remove:function(){return this.removeSubViews(),b.View.prototype.remove.apply(this,arguments)},render:function(){if(this.visible&&this.adView){var a=this.model,b=a&&a.post&&a.post.get("title"),d=this.$el.html(c.render(this.template,{sponsoredTitle:b})).find(this.itemViewContainer);d.append(this.adView.render().$el),this.adView.delegateEvents(),this.$el.show()}else this.$el.hide();return this}});return g}),define("templates/discovery",["handlebars"],function(a){return a.template({1:function(a,b,c,d){var e,f='<div class="follow-btn-wrap">\n';return e=b["if"].call(a,null!=(e=null!=a?a.user:a)?e.isSession:e,{name:"if",hash:{},fn:this.program(2,d),inverse:this.program(5,d),data:d}),null!=e&&(f+=e),f+"</div>\n"},2:function(a,b,c,d){var e,f="";return e=b["if"].call(a,null!=(e=null!=a?a.user:a)?e.isEditable:e,{name:"if",hash:{},fn:this.program(3,d),inverse:this.noop,data:d}),null!=e&&(f+=e),f+"\n"},3:function(a,b,c,d){var e,f=this.lambda,g=this.escapeExpression;return'<a href="'+g(f(null!=(e=null!=a?a.user:a)?e.profileUrl:e,a))+'" data-action="edit-profile" target="_blank" class="btn follow-btn edit-profile">'+g(b.gettext.call(a,"Edit profile",{name:"gettext",hash:{},data:d}))+"</a>\n"},5:function(a,b,c,d){var e,f="";return e=b["if"].call(a,null!=(e=null!=a?a.user:a)?e.isPrivate:e,{name:"if",hash:{},fn:this.program(6,d),inverse:this.program(8,d),data:d}),null!=e&&(f+=e),f},6:function(a,b,c,d){var e=this.escapeExpression;return'<span class="btn follow-btn private">\n<i aria-hidden="true" class="icon-lock"></i>\n<span class="btn-text">'+e(b.gettext.call(a,"Private",{name:"gettext",hash:{},data:d}))+"</span>\n</span>\n"},8:function(a,b,c,d){var e,f=this.lambda,g=this.escapeExpression,h='<a href="'+g(f(null!=(e=null!=a?a.user:a)?e.profileUrl:e,a))+'" class="btn follow-btn ';return e=b["if"].call(a,null!=(e=null!=a?a.user:a)?e.isFollowing:e,{name:"if",hash:{},fn:this.program(9,d),inverse:this.noop,data:d}),null!=e&&(h+=e),h+'" data-action="follow-user" data-user="'+g(f(null!=(e=null!=a?a.user:a)?e.id:e,a))+'">\n<span class="btn-text following-text">'+g(b.gettext.call(a,"Following",{name:"gettext",hash:{},data:d}))+'</span>\n<span class="btn-text follow-text">'+g(b.gettext.call(a,"Follow",{name:"gettext",hash:{},data:d}))+'</span>\n<i aria-hidden="true" class="icon-plus"></i> \n<i aria-hidden="true" class="icon-checkmark"></i>\n</a>\n'},9:function(){return"following"},11:function(a,b,c,d,e){var f,g="";return f=b.each.call(a,null!=a?a.collection:a,{name:"each",hash:{},fn:this.program(12,d,e),inverse:this.noop,data:d}),null!=f&&(g+=f),g},12:function(a,b,c,d,e){var f,g=this.lambda,h=this.escapeExpression,i='<li class="discovery-post';return f=b["if"].call(a,null!=e[1]?e[1].thumbnailsEnabled:e[1],{name:"if",hash:{},fn:this.program(13,d,e),inverse:this.noop,data:d}),null!=f&&(i+=f),i+=" post-"+h(g(d&&d.index,a))+'" id="discovery-link-'+h(g(null!=a?a.domIdSuffix:a,a))+'" data-id="'+h(g(null!=a?a.advertisement_id:a,a))+'">\n<a ',f=this.invokePartial(c.linkAttributes,"","linkAttributes",a,void 0,b,c,d),null!=f&&(i+=f),i+=' class="publisher-anchor-color">\n',f=b["if"].call(a,null!=e[1]?e[1].thumbnailsEnabled:e[1],{name:"if",hash:{},fn:this.program(15,d,e),inverse:this.noop,data:d}),null!=f&&(i+=f),i+='\n<header class="discovery-post-header">\n<h3 title="'+h(g(null!=a?a.title:a,a))+'">\n<span data-role="discovery-thread-title" class="title line-truncate" data-line-truncate="'+h(g(null!=(f=null!=e[1]?e[1].variant:e[1])?f.numLinesHeadline:f,a))+'">\n'+h(b.html.call(a,null!=a?a.title:a,{name:"html",hash:{},data:d}))+"\n</span>\n\n",f=b["if"].call(a,null!=(f=null!=e[1]?e[1].variant:e[1])?f.inlineMeta:f,{name:"if",hash:{},fn:this.program(17,d,e),inverse:this.noop,data:d}),null!=f&&(i+=f),i+="\n</h3>\n\n",f=b.unless.call(a,null!=(f=null!=e[1]?e[1].variant:e[1])?f.inlineMeta:f,{name:"unless",hash:{},fn:this.program(25,d,e),inverse:this.noop,data:d}),null!=f&&(i+=f),i+="</header>\n\n",f=b.if_all.call(a,null!=(f=null!=e[1]?e[1].variant:e[1])?f.contentPreviews:f,null!=a?a.preview:a,{name:"if_all",hash:{},fn:this.program(30,d,e),inverse:this.noop,data:d}),null!=f&&(i+=f),i+"</a>\n</li>\n"},13:function(){return" hasthumbnail"},15:function(a){var b=this.lambda,c=this.escapeExpression;return'<div class="thumbnail"\nstyle="background-image: url('+c(b(null!=a?a.thumbnailUrl:a,a))+');">\n</div>\n'},17:function(a,b,c,d){var e,f="";return e=b["if"].call(a,b.gt.call(a,null!=a?a.posts:a,0,{name:"gt",hash:{},data:d}),{name:"if",hash:{},fn:this.program(18,d),inverse:this.program(20,d),data:d}),null!=e&&(f+=e),e=b["if"].call(a,null!=a?a.brand:a,{name:"if",hash:{},fn:this.program(23,d),inverse:this.noop,data:d}),null!=e&&(f+=e),f},18:function(a,b,c,d){var e,f='<span class="inline-meta">\n';return e=this.invokePartial(c.discoveryPostCount,"","discoveryPostCount",a,void 0,b,c,d),null!=e&&(f+=e),f+"</span>\n"},20:function(a,b,c,d){var e,f="";return e=b["if"].call(a,null!=a?a.createdAgo:a,{name:"if",hash:{},fn:this.program(21,d),inverse:this.noop,data:d}),null!=e&&(f+=e),f},21:function(a){var b=this.lambda,c=this.escapeExpression;return'<span class="inline-meta">'+c(b(null!=a?a.createdAgo:a,a))+"</span>\n"},23:function(a){var b=this.lambda,c=this.escapeExpression;return'<span class="inline-meta">\n'+c(b(null!=a?a.brand:a,a))+"\n</span>\n"},25:function(a,b,c,d){var e,f='<ul class="meta">\n';return e=b["if"].call(a,b.gt.call(a,null!=a?a.posts:a,0,{name:"gt",hash:{},data:d}),{name:"if",hash:{},fn:this.program(26,d),inverse:this.noop,data:d}),null!=e&&(f+=e),e=b["if"].call(a,null!=a?a.createdAgo:a,{name:"if",hash:{},fn:this.program(28,d),inverse:this.noop,data:d}),null!=e&&(f+=e),f+"</ul>\n"},26:function(a,b,c,d){var e,f='<li class="comments">\n';return e=this.invokePartial(c.discoveryPostCount,"","discoveryPostCount",a,void 0,b,c,d),null!=e&&(f+=e),f+"</li>\n"},28:function(a){var b=this.lambda,c=this.escapeExpression;return'<li class="time">'+c(b(null!=a?a.createdAgo:a,a))+"</li>\n"},30:function(a,b,c,d){var e,f="";return e=this.invokePartial(c.discoveryContentPreview,"","discoveryContentPreview",a,void 0,b,c,d),null!=e&&(f+=e),f},32:function(a,b,c,d){var e,f=this.lambda,g=this.escapeExpression,h='href="'+g(f(null!=a?a.redirectUrl:a,a))+'" ';return e=b["if"].call(a,null!=a?a.brand:a,{name:"if",hash:{},fn:this.program(33,d),inverse:this.noop,data:d}),null!=e&&(h+=e),h+"\n"},33:function(){return'target="_blank" rel="nofollow norewrite"'},35:function(a,b,c,d){var e,f=this.lambda,g=this.escapeExpression,h="<a ";return e=this.invokePartial(c.linkAttributes,"","linkAttributes",a,void 0,b,c,d),null!=e&&(h+=e),h+' class="top-comment" data-role="discovery-top-comment">\n<img data-src="'+g(f(null!=(e=null!=(e=null!=(e=null!=a?a.preview:a)?e.author:e)?e.avatar:e)?e.cache:e,a))+'" alt="'+g(b.gettext.call(a,"Avatar",{name:"gettext",hash:{},data:d}))+'" data-role="discovery-avatar">\n<p><span class="user" data-role="discovery-top-comment-author">'+g(f(null!=(e=null!=(e=null!=a?a.preview:a)?e.author:e)?e.name:e,a))+'</span> &#8212; <span data-role="discovery-top-comment-snippet" class="line-truncate" data-line-truncate="3">'+g(f(null!=(e=null!=a?a.preview:a)?e.plaintext:e,a))+"</span></p>\n</a>\n"},37:function(a,b,c,d){var e,f="";return e=b["if"].call(a,b.eq.call(a,null!=a?a.posts:a,1,{name:"eq",hash:{},data:d}),{name:"if",hash:{},fn:this.program(38,d),inverse:this.program(40,d),data:d}),null!=e&&(f+=e),f},38:function(a,b,c,d){var e=this.escapeExpression;return e(b.gettext.call(a,"1 comment",{name:"gettext",hash:{},data:d}))+"\n"},40:function(a,b,c,d){var e=this.escapeExpression;return e(b.gettext.call(a,"%(numPosts)s comments",{name:"gettext",hash:{numPosts:null!=a?a.posts:a},data:d}))+"\n"},42:function(a,b,c,d,e){var f,g=this.lambda,h=this.escapeExpression,i='<div id="'+h(g(null!=a?a.id:a,a))+'" class="discovery-main';return f=b["if"].call(a,null!=a?a.thumbnailsEnabled:a,{name:"if",hash:{},fn:this.program(43,d,e),inverse:this.noop,data:d}),null!=f&&(i+=f),i+=" ",f=b["if"].call(a,null!=a?a.styleVariant:a,{name:"if",hash:{},fn:this.program(45,d,e),inverse:this.noop,data:d}),null!=f&&(i+=f),i+='">\n<div id="discovery-note" class="discovery-note">\n',f=this.invokePartial(c.discoveryNote,"","discoveryNote",a,void 0,b,c,d),null!=f&&(i+=f),i+='</div>\n\n<div class="discovery-options">\n<button class="discovery-help" data-action="discovery-help">\n'+h(b.gettext.call(a,"What's this?",{name:"gettext",hash:{},data:d}))+"\n</button>\n</div>\n\n",f=b.each.call(a,null!=a?a.sections:a,{name:"each",hash:{},fn:this.program(47,d,e),inverse:this.noop,data:d}),null!=f&&(i+=f),i+"\n</div>\n"},43:function(){return" discovery-thumbnails"},45:function(a){var b=this.lambda,c=this.escapeExpression;return"style-variant-"+c(b(null!=a?a.styleVariant:a,a))},47:function(a,b,c,d,e){var f,g=this.lambda,h=this.escapeExpression,i='<section id="'+h(g(null!=a?a.id:a,a))+'" class="'+h(g(null!=a?a.className:a,a))+" discovery-col-"+h(g(d&&d.index,a))+" ";return f=b["if"].call(a,null!=a?a.showThumbnailsInRows:a,{name:"if",hash:{},fn:this.program(48,d,e),inverse:this.noop,data:d}),null!=f&&(i+=f),i+='" >\n<header class="discovery-col-header">\n\n',f=b["if"].call(a,b.eq.call(a,null!=a?a.type:a,"organic",{name:"eq",hash:{},data:d}),{name:"if",hash:{},fn:this.program(50,d,e),inverse:this.noop,data:d}),null!=f&&(i+=f),i+="\n",f=b["if"].call(a,b.eq.call(a,null!=a?a.type:a,"promoted",{name:"eq",hash:{},data:d}),{name:"if",hash:{},fn:this.program(52,d,e),inverse:this.noop,data:d}),null!=f&&(i+=f),i+'\n</header>\n<ul class="discovery-posts">\n</ul>\n</section>\n'},48:function(){return" thumbnails-rows"},50:function(a,b,c,d,e){var f=this.escapeExpression;return"<h2>"+f(b.gettext.call(a,"Also on %(forumName)s",{name:"gettext",hash:{forumName:b.getPartial.call(a,"forumName",null!=e[2]?e[2].forum:e[2],{name:"getPartial",hash:{},data:d})},data:d}))+"</h2>\n"},52:function(a,b,c,d){var e,f="<h2>";return e=b["if"].call(a,null!=a?a.promotedTitle:a,{name:"if",hash:{},fn:this.program(53,d),inverse:this.program(55,d),data:d}),null!=e&&(f+=e),f+"</h2>\n"},53:function(a){var b=this.lambda,c=this.escapeExpression;return"\n<strong>"+c(b(null!=a?a.promotedTitle:a,a))+"</strong>\n"},55:function(a,b,c,d){var e=this.escapeExpression;return e(b.gettext.call(a,"Around The Web",{name:"gettext",hash:{},data:d}))+"\n"},57:function(a,b,c,d){var e=this.escapeExpression;return'<a href="https://help.disqus.com/customer/portal/articles/666278-introducing-promoted-discovery-and-f-a-q-"\ntarget="_blank">'+e(b.gettext.call(a,"Learn more",{name:"gettext",hash:{},data:d}))+"</a>\n"},59:function(a,b,c,d){var e=this.escapeExpression;return'<a href="https://www.surveymonkey.com/s/GHK872T" target="_blank">\n'+e(b.gettext.call(a,"give us feedback",{name:"gettext",hash:{},data:d}))+"</a>"},61:function(a){var b=this.lambda,c=this.escapeExpression;return"<strong>"+c(b(null!=a?a.name:a,a))+"</strong>\n"},63:function(a,b,c,d){var e,f=this.escapeExpression,g='<div class="alert">\n<button class="close" data-action="discovery-help-close" title="'+f(b.gettext.call(a,"Close this box",{name:"gettext",hash:{},data:d}))+'">×</button>\n'+f(b.gettext.call(a,"Disqus helps you find new and interesting content, discussions and products. Some sponsors and ecommerce sites may pay us for these recommendations and links. %(learnMore)s or %(feedback)s.",{name:"gettext",hash:{feedback:b.getPartial.call(a,"feedback",{name:"getPartial",hash:{},data:d}),learnMore:b.getPartial.call(a,"learnMore",{name:"getPartial",hash:{},data:d})},data:d}))+"\n";return e=b.if_all.call(a,null!=(e=null!=(e=null!=a?a.session:a)?e.thread:e)?e.canModerate:e,null!=a?a.discoverySettingsUrl:a,{name:"if_all",hash:{},fn:this.program(64,d),inverse:this.noop,data:d}),null!=e&&(g+=e),g+"</div>\n"},64:function(a,b,c,d){var e,f=this.lambda,g=this.escapeExpression;return'<br/>\n<a href="'+g(f(null!=a?a.discoverySettingsUrl:a,a))+'" target="_blank" class="btn">'+g(b.gettext.call(a,"Change %(Discovery)s settings for %(forumName)s",{name:"gettext",hash:{forumName:null!=(e=null!=a?a.forum:a)?e.name:e,Discovery:"Discovery"},data:d}))+"</a>\n"},66:function(a,b,c,d){var e,f="";return e=b["if"].call(a,null!=a?a.sponsoredTitle:a,{name:"if",hash:{},fn:this.program(67,d),inverse:this.noop,data:d}),null!=e&&(f+=e),f+'<ul class="post-list"></ul>\n'},67:function(a){var b=this.lambda,c=this.escapeExpression;return'<h2 class="highlighted-comment-header">'+c(b(null!=a?a.sponsoredTitle:a,a))+"</h2>\n"},69:function(a,b,c,d){var e,f=this.escapeExpression,g='<div class="sponsored-media">\n<div data-role="media-trigger" class="disqus-video-trigger">\n';return e=b["if"].call(a,null!=a?a.thumbnailUrl:a,{name:"if",hash:{},fn:this.program(70,d),inverse:this.noop,data:d}),null!=e&&(g+=e),g+="</div>\n",e=b["if"].call(a,null!=a?a.showCallToAction:a,{name:"if",hash:{},fn:this.program(72,d),inverse:this.noop,data:d}),null!=e&&(g+=e),g+='</div>\n<div class="comment-text" data-role="sponsored-text">\n'+f(b.html.call(a,null!=a?a.message:a,{name:"html",hash:{},data:d}))+"\n</div>\n",e=b["if"].call(a,null!=a?a.isMobile:a,{name:"if",hash:{},fn:this.program(74,d),inverse:this.noop,data:d}),null!=e&&(g+=e),g},70:function(a,b,c,d){var e=this.escapeExpression;return e(b.getPartial.call(a,null!=a?a.layout:a,{name:"getPartial",hash:{},data:d}))+"\n"},72:function(a,b,c,d){var e=this.lambda,f=this.escapeExpression;return'<a href="'+f(e(null!=a?a.targetUrl:a,a))+'" target="_blank" class="call-to-action-btn" data-role="learn-more">\n'+f(b.gettext.call(a,"Learn More",{name:"gettext",hash:{},data:d}))+' <i class="icon-arrow-forward"></i>\n</a>\n'},74:function(a,b,c,d){var e=this.lambda,f=this.escapeExpression;return'<a href="'+f(e(null!=a?a.targetUrl:a,a))+'" target="_blank" class="learn-more-btn" data-role="learn-more">\n'+f(b.gettext.call(a,"Learn More",{name:"gettext",hash:{},data:d}))+' <i class="icon-arrow-forward"></i>\n</a>\n'},76:function(a,b,c,d){var e=this.lambda,f=this.escapeExpression;return'<a data-role="media-expand" data-action="click_media_expand">\n<img src="'+f(e(null!=a?a.thumbnailUrl:a,a))+'" alt="'+f(b.gettext.call(a,"Thumbnail",{name:"gettext",hash:{},data:d}))+'">\n<div class="play-btn"></div>\n</a>\n'},78:function(){return'<svg class="countdown-circle-back">\n<path transform="rotate(90 35,35)" d="m10,35c0,-13.812155 11.187845,-25 25,-25c13.812153,0 25,11.187845 25,25c0,13.812153 -11.187847,25 -25,25c-13.812155,0 -25,-11.187847 -25,-25z"/>\n</svg>\n<svg class="countdown-circle">\n<path data-role="countdown-path" transform="rotate(90 35,35)" d="m10,35c0,-13.812155 11.187845,-25 25,-25c13.812153,0 25,11.187845 25,25c0,13.812153 -11.187847,25 -25,25c-13.812155,0 -25,-11.187847 -25,-25z"/>\n</svg>\n<div class="countdown-text" data-role="countdown-text"></div>\n'},80:function(a){var b=this.lambda,c=this.escapeExpression;return'<p>\n<a href="'+c(b(null!=a?a.url:a,a))+'" target="_blank">'+c(b(null!=a?a.title:a,a))+"</a>\n</p>\n"+c(b(null!=a?a.summary:a,a))+"\n"},82:function(a,b,c,d){var e,f=this.lambda,g=this.escapeExpression,h='<div class="video-ad">\n<div class="video">\n';return e=b.each.call(a,null!=a?a.media:a,{name:"each",hash:{},fn:this.program(83,d),inverse:this.noop,data:d}),null!=e&&(h+=e),h+='</div>\n<div class="footer ',e=b["if"].call(a,null!=(e=null!=(e=null!=a?a.author:a)?e.avatar:e)?e.cache:e,{name:"if",hash:{},fn:this.program(85,d),inverse:this.noop,data:d}),null!=e&&(h+=e),h+='">\n',e=b["if"].call(a,null!=a?a.targetUrl:a,{name:"if",hash:{},fn:this.program(87,d),inverse:this.noop,data:d}),null!=e&&(h+=e),e=b["if"].call(a,null!=(e=null!=(e=null!=a?a.author:a)?e.avatar:e)?e.cache:e,{name:"if",hash:{},fn:this.program(89,d),inverse:this.noop,data:d}),null!=e&&(h+=e),h+='<div class="brand-content">\n<small class="sponsored-by">\nSponsored By <strong>'+g(f(null!=(e=null!=a?a.author:a)?e.name:e,a))+'</strong>\n</small>\n<p class="brand-summary">\n'+g(f(null!=a?a.summary:a,a))+'\n</p>\n</div>\n<div class="learn-more">\n<a href="'+g(f(null!=a?a.targetUrl:a,a))+'" target="_blank" class="learn-more-btn" data-role="learn-more">\n'+g(b.gettext.call(a,"Learn More",{name:"gettext",hash:{},data:d}))+' <i class="icon-arrow-forward"></i>\n</a>\n</div>\n',e=b["if"].call(a,null!=a?a.targetUrl:a,{name:"if",hash:{},fn:this.program(91,d),inverse:this.noop,data:d}),null!=e&&(h+=e),h+"</div>\n</div>\n"},83:function(a){var b=this.lambda,c=this.escapeExpression;return'<iframe src="'+c(b(null!=a?a.url:a,a))+'" frameborder="0" allowfullscreen></iframe>\n'},85:function(){return"has-brand-logo"},87:function(a){var b=this.lambda,c=this.escapeExpression;return'<a href="'+c(b(null!=a?a.targetUrl:a,a))+'" target="_blank" class="clickable-footer">\n'},89:function(a){var b,c=this.lambda,d=this.escapeExpression;return'<div class="brand-logo avatar">\n<img src="'+d(c(null!=(b=null!=(b=null!=a?a.author:a)?b.avatar:b)?b.cache:b,a))+'" />\n</div>\n'},91:function(){return"</a>\n"},93:function(a){var b=this.lambda,c=this.escapeExpression;return'<div class="generic-ad__block" data-role="iframe-wrapper">\n<div class="icon__block text-subheading">\n<span class="icon-trophy icon"></span> '+c(b(null!=a?a.title:a,a))+'\n</div>\n<iframe class="iframe-ad" src="'+c(b(null!=a?a.iframeUrl:a,a))+'" width="100%" height="'+c(b(null!=a?a.height:a,a))+'" frameborder="0" allowfullscreen overflow="hidden" scrolling="no" data-role="iframe-ad"></iframe>\n</div>\n'},95:function(a,b,c,d){var e,f=this.escapeExpression,g='<div class="video-vast-ad-wrapper">\n<div class="video-vast-ad">\n';return e=b["if"].call(a,null!=a?a.title:a,{name:"if",hash:{},fn:this.program(96,d),inverse:this.noop,data:d}),null!=e&&(g+=e),g+='\n<div class="video-sponsored">\n<span class="icon-trophy"></span> '+f(b.gettext.call(a,"Sponsored Video",{name:"gettext",hash:{},data:d}))+'\n</div>\n<div class="vjs-default-skin" data-role="player-wrapper">\n<video data-role="video-player" class="vjs-start"></video>\n</div>\n<div class="footer" data-role="footer">\n',e=b["if"].call(a,null!=a?a.description:a,{name:"if",hash:{},fn:this.program(98,d),inverse:this.noop,data:d}),null!=e&&(g+=e),g+"</div>\n</div>\n</div>\n"},96:function(a){var b=this.lambda,c=this.escapeExpression;return'<h1 class="video-title">'+c(b(null!=a?a.title:a,a))+"</h1>\n"},98:function(a){var b=this.lambda,c=this.escapeExpression;return'<p class="brand-content">\n'+c(b(null!=a?a.description:a,a))+"\n</p>\n"},100:function(a,b,c,d){var e,f=this.lambda,g=this.escapeExpression,h='<div class="ad-dr -thumb-right clearfix">\n<div class="ad-dr__thumb">\n<a href="'+g(f(null!=a?a.url:a,a))+'" target="_blank"><img src="'+g(f(null!=a?a.thumbnail_url:a,a))+'"></a>\n</div>\n<div class="ad-dr__content">\n<div class="ad-dr__company">\n<a class="publisher-anchor-color" href="'+g(f(null!=a?a.url:a,a))+'" target="_blank">\n';return e=b["if"].call(a,null!=(e=null!=a?a.post:a)?e.author:e,{name:"if",hash:{},fn:this.program(101,d),inverse:this.program(103,d),data:d}),null!=e&&(h+=e),h+='</a><span class="bullet" aria-hidden="true">•</span><span class="icon-trophy" aria-hidden="true"></span><span>'+g(b.gettext.call(a,"Sponsored",{name:"gettext",hash:{},data:d}))+'</span>\n</div>\n<div class="ad-dr__thumb--mobile">\n<a href="'+g(f(null!=a?a.url:a,a))+'" target="_blank"><img src="'+g(f(null!=a?a.thumbnail_url:a,a))+'"></a>\n</div>\n<h2 class="ad-dr__title">\n<a class="publisher-anchor-color" href="'+g(f(null!=a?a.url:a,a))+'" target="_blank">'+g(f(null!=a?a.title:a,a))+'</a>\n</h2>\n<div class="ad-dr__message">\n',e=f(null!=(e=null!=a?a.post:a)?e.raw_message:e,a),null!=e&&(h+=e),h+'\n</div>\n<div class="ad-dr__cta">\n<a class="btn" href="'+g(f(null!=a?a.url:a,a))+'" target="_blank">'+g(b.gettext.call(a,"Learn More",{name:"gettext",hash:{},data:d}))+"</a>\n</div>\n</div>\n</div>\n"},101:function(a){var b,c=this.lambda,d=this.escapeExpression;return d(c(null!=(b=null!=(b=null!=a?a.post:a)?b.author:b)?b.name:b,a))+"\n"},103:function(a){var b=this.lambda,c=this.escapeExpression;return c(b(null!=a?a.brand:a,a))+"\n"},compiler:[6,">= 2.0.0-beta.1"],main:function(a,b,c,d,e){var f,g="";return f=b.partial.call(a,"followButton",{name:"partial",hash:{},fn:this.program(1,d,e),inverse:this.noop,data:d}),null!=f&&(g+=f),g+="\n",f=b.partial.call(a,"discoveryCollection",{name:"partial",hash:{},fn:this.program(11,d,e),inverse:this.noop,data:d}),null!=f&&(g+=f),g+="\n",f=b.partial.call(a,"linkAttributes",{name:"partial",hash:{},fn:this.program(32,d,e),inverse:this.noop,data:d}),null!=f&&(g+=f),g+="\n",f=b.partial.call(a,"discoveryContentPreview",{name:"partial",hash:{},fn:this.program(35,d,e),inverse:this.noop,data:d}),null!=f&&(g+=f),g+="\n",f=b.partial.call(a,"discoveryPostCount",{name:"partial",hash:{},fn:this.program(37,d,e),inverse:this.noop,data:d}),null!=f&&(g+=f),g+="\n",f=b.partial.call(a,"discoveryMain",{name:"partial",hash:{},fn:this.program(42,d,e),inverse:this.noop,data:d}),null!=f&&(g+=f),g+="\n",f=b.partial.call(a,"learnMore",{name:"partial",hash:{},fn:this.program(57,d,e),inverse:this.noop,data:d}),null!=f&&(g+=f),g+="\n",f=b.partial.call(a,"feedback",{name:"partial",hash:{},fn:this.program(59,d,e),inverse:this.noop,data:d}),null!=f&&(g+=f),g+="\n\n",f=b.partial.call(a,"forumName",{name:"partial",hash:{},fn:this.program(61,d,e),inverse:this.noop,data:d}),null!=f&&(g+=f),g+="\n\n",f=b.partial.call(a,"discoveryNote",{name:"partial",hash:{},fn:this.program(63,d,e),inverse:this.noop,data:d}),null!=f&&(g+=f),g+="\n",f=b.partial.call(a,"sponsoredCommentWrapper",{name:"partial",hash:{},fn:this.program(66,d,e),inverse:this.noop,data:d}),null!=f&&(g+=f),g+="\n",f=b.partial.call(a,"sponsoredComment",{name:"partial",hash:{},fn:this.program(69,d,e),inverse:this.noop,data:d}),null!=f&&(g+=f),g+="\n",f=b.partial.call(a,"expandableMedia",{name:"partial",hash:{},fn:this.program(76,d,e),inverse:this.noop,data:d}),null!=f&&(g+=f),g+="\n",f=b.partial.call(a,"countdownTimer",{name:"partial",hash:{},fn:this.program(78,d,e),inverse:this.noop,data:d}),null!=f&&(g+=f),g+="\n",f=b.partial.call(a,"appNexusMessage",{name:"partial",hash:{},fn:this.program(80,d,e),inverse:this.noop,data:d}),null!=f&&(g+=f),g+="\n",f=b.partial.call(a,"videoAd",{name:"partial",hash:{},fn:this.program(82,d,e),inverse:this.noop,data:d}),null!=f&&(g+=f),g+="\n",f=b.partial.call(a,"iframeAd",{name:"partial",hash:{},fn:this.program(93,d,e),inverse:this.noop,data:d}),null!=f&&(g+=f),g+="\n",f=b.partial.call(a,"videoVastAd",{name:"partial",hash:{},fn:this.program(95,d,e),inverse:this.noop,data:d}),null!=f&&(g+=f),g+="\n",f=b.partial.call(a,"imageAd",{name:"partial",hash:{},fn:this.program(100,d,e),inverse:this.noop,data:d}),null!=f&&(g+=f),g
},usePartial:!0,useData:!0,useDepths:!0})}),define("discovery/main",["backbone","underscore","jquery","stance","when","core/analytics/jester","core/utils","core/bus","common/defines","common/templates","common/utils","remote/config","discovery/collections","discovery/custom-comments","discovery/helpers","discovery/variants","discovery/views","discovery/views/Placement","templates/discovery"],function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s){"use strict";s();var t={},u=1e4,v="discovery-top";return t.DiscoveryApp=a.Model.extend({defaults:{name:"promoted",inlineMeta:!0,contentPreviews:!1,organicEnabled:!0,promotedEnabled:!0,topPlacementEnabled:!1,redirectUrl:"http://redirect.disqus.com/url",sourceThread:null,sourceForum:null,sourceThreadUrl:null,discoverySettingsUrl:null,help:!1,display:!1,columnEveningEnabled:!0,numColumns:2,minPerColumn:1,maxPerColumn:null,toleranceCoefficient:1.2,maxOrganicTextLinks:null,maxPromotedTextLinks:null,maxOrganicThumbnailLinks:null,maxPromotedThumbnailLinks:null,maxPromotedThumbnailLinksMobile:null,minWidthForColumnLayout:440,containerId:"discovery",innerContainerName:"discovery-main",sectionNames:null,collectionTagName:"ul",collectionClassName:"discovery-posts",promotedSide:"right",organicThumbnailClass:"discovery-thumbnails",promotedThumbnailClass:"doublethumbnails",styleVariant:"default",sponsoredCommentStyleVariant:"default",injectScriptUrl:void 0,hasSpaceForSponsoredComment:!1,sponsoredCommentsEnabled:!1,sponsoredCommentId:null,consoleLoggingEnabled:i.debug,lineTruncationEnabled:!0,session:null,numLinesHeadline:2,requestBinOverride:null,thumbnailMinHeight:200,thumbnailMinWidth:200,thumbnailAspectRatioMin:.5,thumbnailAspectRatioMax:1.8,shouldEvenThumbnails:!1,thumbnailTimeout:2e3,minThumbnailsNeeded:null,js:null,css:null,seenByUserThresholdTime:2e3,trackAdVisibility:null},get:function(b){if(b in this.constructor.loggedinOverrides){var c=this.get("session");if(c&&c.isLoggedIn())return this.constructor.loggedinOverrides[b]}return a.Model.prototype.get.apply(this,arguments)},initialize:function(a){var c=this;c.collections=[],c.ads=new m.AdvertisementCollection,c.augmentCollection(c.ads,"Promoted"),c.threads=new m.RelatedThreadCollection,c.augmentCollection(c.threads,"Organic"),c.userSuggestions=a.userSuggestions,c.configure(a),c.once("change:display",function(){c.onComplete()}),b.bindAll(c,"getContentPreviews","validateData","prepareData","showData","reportIfVisible")},trackVisibility:function(){this.debouncedReportIfVisible=b.debounce(this.reportIfVisible,this.get("seenByUserThresholdTime")),this.visibilityTracker=d(this.mainView),this.listenTo(this.visibilityTracker,"enter",this.debouncedReportIfVisible)},configure:function(a){a=a||{};var c=this,d=p[c.get("name")]||{};if(c.get("thumbnailsEnabled")&&b.extend(d,p.thumbnails),c.set(b.defaults(a,d)),c.has("maxPerColumn")){var e=c.get("promotedEnabled")?1:2;c.set("maxOrganicTextLinks",e*c.get("maxPerColumn")),c.set("maxPromotedTextLinks",c.get("maxPerColumn"))}else c.has("maxOrganicTextLinks")&&c.set("maxPerColumn",c.get("maxOrganicTextLinks"));c.set("innerContainerId",c.get("innerContainerName")+"-"+c.cid),c.get("sectionNames")||c.set("sectionNames",["col-organic","col-promoted"]),c.set("sectionIds",b.map(c.get("sectionNames"),function(a){return a+"-"+c.cid}))},numSections:function(){return this.collections.length||(this.get("promotedEnabled")?2:1)},commonClickMetadata:function(){var a=this.get("sourceForum"),b={redirectUrl:this.get("redirectUrl"),sourceThreadId:this.get("sourceThread").id,forumId:a.pk,forum:a.id,majorVersion:this.majorVersion(),requestBin:this.get("requestBin"),service:this.get("service")},c=this.get("session");return c&&c.isLoggedIn()&&(b.userId=c.user.id),b},augmentModels:function(a){a.invoke("set",this.commonClickMetadata())},getViewportWidth:function(){return c(document).width()},getThumbnailLinksMobile:function(a){return this.getViewportWidth()<=480&&this.get("max"+a+"ThumbnailLinksMobile")},augmentCollection:function(a,b){var c=this;a.meta={max:function(){return c.getThumbnailLinksMobile(b)||c.get("max"+b+"ThumbnailLinks")||c.get("max"+b+"TextLinks")},min:function(){return c.get("minThumbnailsNeeded")||c.get("numColumns")/c.numSections()*c.get("minPerColumn")},name:b}},run:function(){var a=b.bind(this.configureContainerId,this),c=b.bind(this.onComplete,this);this.getData().then(a).then(this.validateData).then(this.prepareData).then(this.showData).otherwise(c)},getDataOrganic:function(){var a=this,b={timeout:u,data:{thread:this.get("sourceThread").id,limit:2*a.threads.meta.max()},sourceThread:this.get("sourceThread"),reset:!0};b.humanFriendlyTimestamp=!0;var c=e(a.threads.fetch(b));return a.get("contentPreviews")&&(c=c.then(function(){return a.getContentPreviews().otherwise(function(a){o.log("There was a problem getting snippets: ",a)})})),c},deactivateThumbnails:function(){this.set({columnEveningEnabled:!0,contentPreviews:!0})},fetchAds:function(a){return e(this.ads.fetch(a))},getDataPromoted:function(){var a=this;a.get("preview")&&a.has("previewQueryParam")&&(a.ads.url="//tempest.services.disqus.com/preview/serve/"+a.get("previewQueryParam")),a.augmentCollection(a.ads,"Promoted");var c={timeout:u,data:{thread:this.get("sourceThread").id,count:2*a.ads.meta.max()},sourceThread:this.get("sourceThread"),dataType:"jsonp",omitDisqusApiKey:!0,reset:!0};null!==a.get("sponsoredCommentId")&&(c.data.HTTP_X_DEBUG=1,c.data.HTTP_X_DEBUG_AD_ID=a.get("sponsoredCommentId")),null!==a.get("requestBinOverride")&&(c.data.HTTP_X_DEBUG=1,c.data.HTTP_X_DEBUG_BIN=a.get("requestBinOverride"));var d=a.fetchAds(c);return d.then(function(c){var e=c.bin;if(!e)return d;if(a.has("requestBin"))return d;a.set("requestBin",e);var g,h=c.extra;return h&&h.service&&h.service_version&&(g=b.pick(h,"service","service_version"),f.client.set(g),a.set("service",g)),a.handleExperiment(e)}).then(b.bind(a.augmentSponsoredCommentCollection,a)).always(function(){a.hasSponsoredComments()&&a.get("sponsoredCommentsEnabled")&&a.set("topPlacementEnabled",!1)})},augmentSponsoredCommentCollection:function(){var a=this.ads.sponsoredComment;if(a&&a.post&&a.thread){var c=a.get("ad_provider");if(c&&(this.ads.sponsoredComment.clear(),b.has(n.handlers,c)))return n.handlers[c].call(this,a)}},hasSponsoredComments:function(){return this.ads&&this.ads.sponsoredComment&&this.ads.sponsoredComment.post},configureContainerId:function(){this.get("topPlacementEnabled")&&this.set("containerId",v)},getData:function(){var a=e();if(this.get("organicEnabled")){var c=this.getDataOrganic();a=a.always(function(){return c})}if(this.get("promotedEnabled")||this.get("sponsoredCommentsEnabled")){var d=this.getDataPromoted();a=a.always(function(){return d})}return a.always(b.bind(this.sequenceDataCollections,this))},sequenceDataCollections:function(){this.collections=[this.threads],this.get("promotedEnabled")&&this.collections.push(this.ads),this.collections=b.compact(this.collections);var a=this.get("promotedEnabled")&&1===this.collections.length,c=this.get("promotedEnabled")&&"left"===this.get("promotedSide");(c||a)&&(this.get("sectionNames")&&this.get("sectionNames").reverse(),this.get("sectionIds")&&this.get("sectionIds").reverse(),this.collections.reverse())},handleExperiment:function(a){return this.experimentHandlers[a]?this.experimentHandlers[a].call(this):void 0},experimentHandlers:{"embed:sponsored_comment:tempest:display:call_to_action":function(){this.set({sponsoredCommentExperiment:"call_to_action"})},"embed:promoted_discovery:tempest:display:six_ads":function(){this.get("thumbnailsEnabled")&&this.set({maxPromotedThumbnailLinks:6}),this.set({maxPerColumn:6,maxPromotedTextLinks:6,maxOrganicTextLinks:6,styleVariant:"six-ads"})},"embed:sponsored_comment:tempest:display:moat_direct_script":function(){this.set({injectScriptUrl:"//js.moatads.com/disqus424396128776/moatad.js#moatClientLevel1=Disqus&moatClientLevel2=<%=adId%>&moatClientLevel3=<%=adId%>&moatClientLevel4=<%=adId%>&moatClientSlicer1=<%=threadId%>&moatClientSlicer2=-"})},"embed:sponsored_comment:tempest:display:moat_script":function(){this.set({injectScriptUrl:"//z.moatads.com/247realmediaappnexus789806200409/moatad.js#moatClientLevel1=Disqus&moatClientLevel2=<%=adId%>&moatClientLevel3=<%=adId%>&moatClientLevel4=<%=adId%>&moatClientSlicer1=<%=threadId%>&moatClientSlicer2=-"})},"embed:sponsored_comment:tempest:display:integral_script":function(){this.set({injectScriptUrl:"//pixel.adsafeprotected.com/jload?anId=7253&advId=<%=adId%>&campId=<%=adId%>&pubId=Disqus&chanId=<%=forumId%>&placementId=<%=threadId%>"})},"embed:sponsored_comment:tempest:display:auto_expand":function(){this.set({sponsoredCommentExperiment:"auto_expand"})},"embed:sponsored_comment:tempest:display:bubble_25perc":function(){this.trigger("init:bubble",{targetPerc:.25,reportOptions:o.binToEventParams(this.get("requestBin"))})},"embed:sponsored_comment:tempest:display:bubble_50perc":function(){this.trigger("init:bubble",{targetPerc:.5,reportOptions:o.binToEventParams(this.get("requestBin"))})},"embed:sponsored_comment:tempest:display:bubble_75perc":function(){this.trigger("init:bubble",{targetPerc:.75,reportOptions:o.binToEventParams(this.get("requestBin"))})},"embed:promoted_discovery:tempest:thumbnails:control":function(){this.set({maxPromotedThumbnailLinks:!1,promotedSide:"max"===this.get("name")?"left":"right",numLinesHeadline:2})},"embed:promoted_discovery:tempest:thumbnails:quarantine":function(){return this.experimentHandlers["embed:promoted_discovery:tempest:thumbnails:control"].call(this)}},getContentPreviews:function(){var a=this.threads.map(function(a){return parseInt(a.get("id"),10)});if(a.length<this.threads.meta.min())return e.resolve();a.sort(function(a,b){return a-b}),this.previews=new m.PostCollection;var c=e(this.previews.fetch({data:{thread:a},timeout:this.get("httpTimeout")}));return c.then(b.bind(this.attachPreviews,this))},attachPreviews:function(){var a=this;a.previews.each(function(b){var c=b.get("thread"),d=a.threads.get(c);d&&d.set("preview",b)})},validateCollectionMin:function(){for(var a,b,c=this.collections,d=this.get("sectionNames").slice(0),e=this.get("sectionIds").slice(0),f=c.length;f>0;)a=c[--f],b=a.meta.min(),a.length<b&&(c.splice(f,1),d.splice(f,1),e.splice(f,1),f=c.length);this.set("sectionNames",d),this.set("sectionIds",e)},prepareData:function(){this.trimCollections()},trimCollections:function(){for(var a,b,c=this.collections,d=c.length,e=0;d>e;e++)a=c[e],b=a.meta.max(),a.length>b&&a.reset(a.slice(0,b));this.get("shouldEvenThumbnails")&&this.threads.length%2!==0&&(o.log("Number of related threads ("+this.threads.length+") is odd.","Removing one to make even."),this.threads.pop())},isThumbnailOk:function(a){var b=this,c=a.width,d=a.height,e=c/d;return c>=b.get("thumbnailMinWidth")&&d>=b.get("thumbnailMinHeight")&&e>=b.get("thumbnailAspectRatioMin")&&e<=b.get("thumbnailAspectRatioMax")},areThumbnailsGood:function(a,d){var f=this;return a.map(function(a){var g,h=new Image,i=e.defer();return c(h).on("load",function(){f.isThumbnailOk(this)?(d.push(a),i.resolve(a.id)):(o.log("Image is not good. Width",this.width,"Height",this.height,"Aspect Ratio",this.width/this.height,"Src",this.src),i.reject("Image is not good")),clearTimeout(g)}).on("error",function(){o.log("Image could not be loaded. Src",this.src),i.reject("Error loading image"),clearTimeout(g)}),h.src=a.get("thumbnail"),g=b.delay(function(){o.log("Image is taking too long to load. Src",h.src),i.reject("Image taking too long")},f.get("thumbnailTimeout")),i.promise})},validateThumbnails:function(a){function c(){return o.log("Verified minimum number of thumbnails needed: "+g),e.some(j,h).then(function(c){var d=a.pluck("id"),e=b.difference(d,c);o.log("Maximum number ("+h+") of thumbnails verified.","Removing excess models.",e),a.reset(i)},function(){o.log("Cannot reach thumbnail max. Carrying on with the amount obtained: "+i.length),a.reset(i)})}function d(){o.log("Cannot get enough good thumbnails. Falling back to normal design."),f.set("maxOrganicThumbnailLinks",0),1===f.collections.length&&f.deactivateThumbnails()}if(a.length){var f=this,g=a.meta.min(),h=a.meta.max(),i=[],j=f.areThumbnailsGood(a,i);return j.length<g?e.resolve(d()):e.some(j,g).then(c,d)}},validateData:function(){return g.isMobileUserAgent()&&this.ads&&this.ads.length>0&&this.ads.remove(this.ads.where({mobile:!1})),this.validateCollectionMin(),b.each(this.collections,this.augmentModels,this),this.threads&&this.get("maxOrganicThumbnailLinks")?this.validateThumbnails(this.threads):void 0},renderViews:function(){if(this.hasSponsoredComments()&&this.get("sponsoredCommentsEnabled")&&!this.get("topPlacementEnabled")&&this.renderTopPlacement(),!this.collections.length)throw new Error("Not enough data");this.renderMainViews(),this.get("trackAdVisibility")&&this.trackVisibility()},renderMainViews:function(){var a=document.getElementById(this.get("containerId"));if(!a)throw new Error("No container on the DOM");var d=this.mainView=new q.MainView({el:a,model:this});d.render();var e=this.get("sectionIds"),f=this.get("collectionTagName"),g=this.get("collectionClassName");this.views=b.map(this.collections,function(a,b){var d=!!this.get("max"+a.meta.name+"ThumbnailLinks"),h=new q.BaseCollectionView({model:this,collection:a,el:c("#"+e[b]+" "+f+"."+g),context:{thumbnailsEnabled:d}});return a.meta.view=h,h},this),this.get("maxPromotedThumbnailLinks")?d.$el.find("#"+this.get("innerContainerId")).addClass("doublethumbnails"):2===this.views.length&&d.$el.find("#"+this.get("innerContainerId")).addClass("doublesection"),b.invoke(this.views,"render")},canShowSponsoredComment:function(){return this.get("hasSpaceForSponsoredComment")&&this.get("sponsoredCommentsEnabled")},renderTopPlacement:function(){var a=document.getElementById(v);if(a){var b=new r({el:a,model:this.ads.sponsoredComment,styleVariant:this.get("sponsoredCommentStyleVariant"),session:this.get("session"),userSuggestions:this.userSuggestions,visible:this.canShowSponsoredComment(),sponsoredCommentExperiment:this.get("sponsoredCommentExperiment"),sourceForum:this.get("sourceForum"),sourceThread:this.get("sourceThread"),requestBin:this.get("requestBin"),injectScriptUrl:this.get("injectScriptUrl")});b.render(),this.listenTo(this,"change:hasSpaceForSponsoredComment",function(){b.setVisible(this.canShowSponsoredComment())})}},areThumbnailsViable:function(){return b.any(this.collections,function(a){return this.get("max"+a.meta.name+"ThumbnailLinks")},this)},evenColumns:function(){var a=this;if(!a.areThumbnailsViable())if(a.get("columnEveningEnabled")&&a.mainView.$el.width()>a.get("minWidthForColumnLayout")){var c=new q.TwoColumn({views:a.views,fudge:this.get("toleranceCoefficient")});c.render()}else{var d=b.min(b.pluck(a.collections,"length"));b.each(a.views,function(a){for(;a.collection.length>d;)a.collection.pop()})}},showData:function(){this.renderViews(),this.manageAdblock(),this.evenColumns(),this.set("display",!0)},manageAdblock:function(){var a=this.ads&&this.ads.meta.view;if(a&&o.looksAdblocked(a.el)){if(!(this.views.length>1))throw new Error("No organic results and promoted results appear to be blocked");this.mainView.remove({cloneContainer:!0}),this.ads.reset(null,{silent:!0}),this.validateCollections(),this.renderViews()}},onComplete:function(a){var b=o.log;return a&&b("It looks like there was a problem:",a),this.onCompleteCalled?b("Error: Final reporting function called more than once"):(this.onCompleteCalled=!0,void(this.get("promotedEnabled")&&this.report({event:"activity.load_advertisement",verb:"load"})))},report:function(a){b.isEmpty(a)||f.client.emit(b.extend(this.snapshot(),a))},reportIfVisible:function(){this.visibilityTracker&&this.visibilityTracker.isVisible()&&this.ads&&this.ads.length&&(this.stopListening(this.visibilityTracker),this.visibilityTracker=null,this.report({verb:"view"}))},majorVersion:function(){return this.get("promotedEnabled")?"midway":"metadata"},snapshot:function(){var a=this.threads,c=o.binToEventParams(this.get("requestBin")),d=this.get("session"),e=d&&d.isLoggedIn()?{userId:d.user.id}:{},f=b.extend({major_version:this.majorVersion(),internal_organic:a&&a.length,external_organic:0,promoted:0,display:this.get("display"),placement:this.get("containerId")===v?"top":"bottom",zone:"thread",area:"discovery",thread_id:this.get("sourceThread").id,forum_id:this.get("sourceForum").pk},e,c,this.getAdData());return f},getAdData:function(){if(!this.get("promotedEnabled"))return{object_type:"link"};var a=JSON.stringify(this.ads.pluck("advertisement_id"));return{promoted:this.ads.length,promoted_ids:a,object_type:"advertisement",object_id:a,advertisement_id:a,ad_product_name:"traffic"}}},{loggedinOverrides:{topPlacementEnabled:!1,promotedSide:"right"}}),t.init=function(a,c,d,e){var f=a.forum.get("settings"),g=o.generateVariantConfig(f,c,d);if(g){var h=b.extend(g,e,{sourceThread:a.toJSON(),sourceForum:a.forum.toJSON(),sourceThreadUrl:a.currentUrl||document.referrer,discoverySettingsUrl:f.discoverySettingsUrl,sponsoredCommentsEnabled:f.sponsoredCommentsEnabled,organicEnabled:f.organicDiscoveryEnabled,topPlacementEnabled:g.topPlacementEnabled&&e.hasSpaceForSponsoredComment});if(d.preview){var i=document.createElement("a");i.href=h.sourceThreadUrl,h.previewQueryParam=i.search,h.preview=!0}var j=c.get("sponsoredCommentAdId")||d.sponsored_comment_id;j&&(h.sponsoredCommentsEnabled=!0,h.sponsoredCommentId=j);var k=c.get("discoveryRequestBin");k&&(h.requestBinOverride=k);var l=["lineTruncationEnabled","consoleLoggingEnabled"];o.config(b.defaults(b.pick(h,l),b.pick(t.DiscoveryApp.prototype.defaults,l)));var m=new t.DiscoveryApp(h);return m.run(),m}},t}),define("discovery.bundle",function(){});